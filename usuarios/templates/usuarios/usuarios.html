{% extends 'base.html' %}

{% block title %}Usuarios{% endblock %}

{% block content %}
<style>
  h2 {
      margin-bottom: 20px;
      color: white;
      text-align: center;
  }
  table {
    width: 1000px; /* Fijo o el valor que prefieras */
    table-layout: fixed;
    border-collapse: collapse;
    margin-bottom: 20px;
    background-color: #0f172a;
    color: white;
    border-radius: 10px;
    overflow: hidden;
  }

  th, td {
      padding: 12px 16px;
      border: 1px solid #334155;
      text-align: left;
      font-size: 14px;
      word-wrap: break-word;
      overflow-wrap: break-word;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
  }

  th:nth-child(1), td:nth-child(1) { width: 40px; }      /* Checkbox */
  th:nth-child(2), td:nth-child(2) { width: 300px; }     /* Nombre */
  th:nth-child(3), td:nth-child(3) { width: 120px; }     /* Usuario */
  th:nth-child(4), td:nth-child(4) { width: 300px; }     /* Email */
  th:nth-child(5), td:nth-child(5) { width: 120px; }     /* Teléfono */
  th:nth-child(6), td:nth-child(6) { width: 120px; }     /* Estado */

  th {
      background-color: #1e40af;
      color: white;
  }
  tr:nth-child(even) {
      background-color: #1e293b;
  }
  tr:hover {
      background-color: #334155;
  }

  .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      margin-right: 5px;
      font-size: 14px;
  }
  .btn-editar {
      background-color: #22d3ee;
      color: black;
  }
  .btn-eliminar {
      background-color: #ef4444;
      color: white;
  }
  .btn-estado {
      background-color: #facc15;
      color: black;
  }
  .btn-agregar {
      background-color: #10b981;
      color: white;
      margin-bottom: 20px;
  }
  .badge-activo {
      background-color: #22c55e;
      padding: 5px 10px;
      border-radius: 5px;
      font-weight: bold;
  }
  .badge-inactivo {
      background-color: #ef4444;
      padding: 5px 10px;
      border-radius: 5px;
      font-weight: bold;
  }
  .pagination { display: flex; justify-content: center; align-items: center; margin-top: 20px; }
  .pagination a, .pagination span {
      color: white; background-color: #1e3a5f;
      padding: 8px 14px; margin: 0 4px;
      border-radius: 6px; text-decoration: none;
  }
  .pagination a:hover { background-color: #2563eb; }
  .pagination .current { background-color: #10b981; font-weight: bold; }

  .sort-link {
    color: #f1f5f9;
    text-decoration: none;
    font-weight: bold;
    display: inline-block;
    padding: 6px 10px;
    border-radius: 6px;
    background-color: #1e40af;
    transition: background-color 0.3s, box-shadow 0.3s;
  }
  .sort-link:hover {
    background-color: #2563eb;
    box-shadow: 0 0 5px #3b82f6;
  }
  .sort-link span {
    margin-left: 5px;
  }

</style>

<h2>Gestión de Usuarios</h2>

<div class="mb-4">
  <button class="btn btn-agregar" onclick="abrirModal()">AGREGAR USUARIO</button>
  <button class="btn btn-editar" id="btn-editar" disabled>Editar</button>
  <button class="btn btn-eliminar" id="btn-eliminar" disabled>Eliminar</button>
  <button class="btn btn-estado" id="btn-cambiar-estado" disabled>Cambiar Estado</button>
  <span id="contador-seleccionados" style="color: white; margin-left: 20px;">0 seleccionados</span>
</div>

<div style="overflow-x: auto;">
  <table>
    <thead>
      <tr>
        <th><input type="checkbox" id="check-todos"></th>
        <th>
          <a href="?sort_by=nombre&order={% if sort_by == 'nombre' and order == 'asc' %}desc{% else %}asc{% endif %}{% if page_size %}&page_size={{ page_size }}{% endif %}" class="sort-link">
            Nombre
            {% if sort_by == 'nombre' %}
              {% if order == 'asc' %}▲{% else %}▼{% endif %}
            {% endif %}
          </a>
        </th>
        <th>
          <a href="?sort_by=username&order={% if sort_by == 'username' and order == 'asc' %}desc{% else %}asc{% endif %}{% if page_size %}&page_size={{ page_size }}{% endif %}" class="sort-link">
            Usuario
            {% if sort_by == 'username' %}
              {% if order == 'asc' %}▲{% else %}▼{% endif %}
            {% endif %}
          </a>
        </th>
        <th>
          <a href="?sort_by=email&order={% if sort_by == 'email' and order == 'asc' %}desc{% else %}asc{% endif %}{% if page_size %}&page_size={{ page_size }}{% endif %}" class="sort-link">
            Email
            {% if sort_by == 'email' %}
              {% if order == 'asc' %}▲{% else %}▼{% endif %}
            {% endif %}
          </a>
        </th>
        <th>
          <a href="?sort_by=telefono&order={% if sort_by == 'telefono' and order == 'asc' %}desc{% else %}asc{% endif %}{% if page_size %}&page_size={{ page_size }}{% endif %}" class="sort-link">
            Teléfono
            {% if sort_by == 'telefono' %}
              {% if order == 'asc' %}▲{% else %}▼{% endif %}
            {% endif %}
          </a>
        </th>
        <th>
          <a href="?sort_by=estado&order={% if sort_by == 'estado' and order == 'asc' %}desc{% else %}asc{% endif %}{% if page_size %}&page_size={{ page_size }}{% endif %}" class="sort-link">
            Estado
            {% if sort_by == 'estado' %}
              {% if order == 'asc' %}▲{% else %}▼{% endif %}
            {% endif %}
          </a>
        </th>
      </tr>
    </thead>

    <tbody>
      {% for usuario in usuarios %}
      <tr data-id="{{ usuario.id }}">
        <td><input type="checkbox" class="check-usuario"></td>
        <td>{{ usuario.first_name }} {{ usuario.perfilusuario.segundo_nombre }} {{ usuario.last_name }} {{ usuario.perfilusuario.segundo_apellido }}</td>
        <td>{{ usuario.username }}</td>
        <td>{{ usuario.email }}</td>
        <td>{{ usuario.perfilusuario.telefono }}</td>
        <td>
          {% if usuario.perfilusuario.estado == "activo" %}
            <span class="badge-activo">ACTIVO</span>
          {% else %}
            <span class="badge-inactivo">INACTIVO</span>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="6" style="text-align:center;">No hay usuarios registrados.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Paginación -->
{% if page_obj %}
  <div class="pagination">
    {% if page_obj.has_previous %}
      <a href="?page=1">&laquo; Primera</a>
      <a href="?page={{ page_obj.previous_page_number }}">Anterior</a>
    {% endif %}

    <span class="current">
      Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
    </span>

    {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}">Siguiente</a>
      <a href="?page={{ page_obj.paginator.num_pages }}">Última &raquo;</a>
    {% endif %}
  </div>
{% endif %}

<!-- Modales -->
{% include 'usuarios/modal_agregar.html' %}
{% include 'usuarios/modal_editar.html' %}
{% include 'usuarios/modal_eliminar.html' %}

<script>
  const btnEditar = document.getElementById("btn-editar");
  const btnEliminar = document.getElementById("btn-eliminar");
  const btnCambiarEstado = document.getElementById("btn-cambiar-estado");
  const contador = document.getElementById("contador-seleccionados");

  document.addEventListener("DOMContentLoaded", () => {
    const checkTodos = document.getElementById("check-todos");
    const checkboxes = document.querySelectorAll(".check-usuario");

    function actualizarBotones() {
      const seleccionados = document.querySelectorAll(".check-usuario:checked");
      contador.textContent = `${seleccionados.length} seleccionados`;
      btnEliminar.disabled = seleccionados.length === 0;
      btnCambiarEstado.disabled = seleccionados.length === 0;
      btnEditar.disabled = seleccionados.length !== 1;
    }

    checkTodos.addEventListener("change", () => {
      checkboxes.forEach(cb => cb.checked = checkTodos.checked);
      actualizarBotones();
    });
    checkboxes.forEach(cb => cb.addEventListener("change", actualizarBotones));

    btnEditar.addEventListener("click", () => {
      const seleccionado = document.querySelector(".check-usuario:checked");
      const fila = seleccionado.closest("tr");
      const id = fila.dataset.id;
      abrirModalEditarDesdeID(id);
    });

    btnEliminar.addEventListener("click", () => {
      const ids = [...document.querySelectorAll(".check-usuario:checked")].map(cb => cb.closest("tr").dataset.id);
      fetch("{% url 'eliminar_usuarios' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ ids })
      }).then(() => location.reload());
    });

    btnCambiarEstado.addEventListener("click", () => {
      const ids = [...document.querySelectorAll(".check-usuario:checked")].map(cb => cb.closest("tr").dataset.id);
      fetch("{% url 'cambiar_estado_usuarios' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ ids })
      }).then(() => location.reload());
    });
  });
</script>

<script>
  function abrirModal() {
    document.getElementById("modalUsuario").style.display = "block";
  }

  function cerrarModal() {
    document.getElementById("modalUsuario").style.display = "none";
  }

  function cerrarModalEditar() {
    document.getElementById("modalEditarUsuario").style.display = "none";
  }

  function abrirModalEditarDesdeID(id) {
    fetch(`/usuarios/obtener/${id}/`)
      .then(res => res.json())
      .then(data => {
        if (!data.error) {
          document.getElementById("edit_user_id").value = id;
          document.getElementById("edit_first_name").value = data.first_name;
          document.getElementById("edit_last_name").value = data.last_name;
          document.getElementById("edit_segundo_apellido").value = data.segundo_apellido;
          document.getElementById("edit_segundo_nombre").value = data.segundo_nombre;
          document.getElementById("edit_email").value = data.email;
          document.getElementById("edit_telefono").value = data.telefono;
          document.getElementById("modalEditarUsuario").style.display = "block";
        } else {
          alert("No se pudo obtener el usuario.");
        }
      });
  }
</script>

{% endblock %}
