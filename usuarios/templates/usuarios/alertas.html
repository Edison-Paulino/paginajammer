{% extends 'base.html' %}

{% block title %}Alertas{% endblock %}

{% block content %}
<!-- Estilos personalizados para la tabla de alertas -->
<style>
  h2 {
    margin-bottom: 20px;
    color: white;
    text-align: center;
  }
  table {
    width: 1000px;
    table-layout: fixed;
  /* Bordes de la tabla y celdas */
    border-collapse: collapse;
  /* Color de fondo de la tabla */
    background-color: #0f172a;
    color: white;
  /* Bordes de la tabla y celdas */
    border-radius: 10px;
    overflow: hidden;
    margin: auto;
  }
  th, td {
    padding: 12px 16px;
  /* Bordes de la tabla y celdas */
    border: 1px solid #334155;
    text-align: left;
    font-size: 14px;
    word-wrap: break-word;
    overflow-wrap: break-word;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  th:nth-child(1), td:nth-child(1) { width: 150px; }
  th:nth-child(2), td:nth-child(2) { width: 300px; }
  th:nth-child(3), td:nth-child(3) { width: 400px; }
  th:nth-child(4), td:nth-child(4) { width: 80px; }
  th:nth-child(5), td:nth-child(5) { width: 70px; }
  th {
  /* Color de fondo de la tabla */
    background-color: #1e40af !important;
    color: white !important;
  }

  th a {
  color: white !important;
  text-decoration: none;
}
th a:hover {
  color: #cbd5e1 !important;
}


  /* Color de fondo de la tabla */
  tr:nth-child(even) { background-color: #1e293b; }
  /* Color de fondo de la tabla */
  tr:hover { background-color: #334155; }
  .alert {
    position: fixed;
    top: 20px;
    right: 20px;
  /* Color de fondo de la tabla */
    background-color: #1e3a8a;
    color: white;
    padding: 10px 20px;
  /* Bordes de la tabla y celdas */
    border-radius: 8px;
    z-index: 9999;
    opacity: 0.9;
  }
  /* Color de fondo de la tabla */
  .nivel-INFO { background-color: #10b981; }
  /* Color de fondo de la tabla */
  .nivel-WARN { background-color: #facc15; color: black; }
  /* Color de fondo de la tabla */
  .nivel-ERROR { background-color: #ef4444; }
  /* Color de fondo de la tabla */
  .nivel-CRITICAL { background-color: #b91c1c; }
  .nivel-INFO, .nivel-WARN, .nivel-ERROR, .nivel-CRITICAL {
    font-weight: bold;
    padding: 4px 10px;
  /* Bordes de la tabla y celdas */
    border-radius: 6px;
    font-size: 12px;
    display: inline-block;
  }
  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 20px;
  }
  .pagination a, .pagination span {
    color: white;
  /* Color de fondo de la tabla */
    background-color: #1e3a5f;
    padding: 8px 14px;
    margin: 0 4px;
  /* Bordes de la tabla y celdas */
    border-radius: 6px;
    text-decoration: none;
  /* Color de fondo de la tabla */
    transition: background-color 0.3s;
  }
  /* Color de fondo de la tabla */
  .pagination a:hover { background-color: #2563eb; }
  .pagination .current {
  /* Color de fondo de la tabla */
    background-color: #10b981;
    font-weight: bold;
  }
  .pagination button {
    color: white;
  /* Color de fondo de la tabla */
    background-color: #1e3a5f;
    padding: 8px 14px;
    margin: 0 4px;
  /* Bordes de la tabla y celdas */
    border-radius: 6px;
    text-decoration: none;
  /* Color de fondo de la tabla */
    transition: background-color 0.3s;
  /* Bordes de la tabla y celdas */
    border: none;
    font-weight: bold;
    cursor: pointer;
  }
  .pagination button:hover {
  /* Color de fondo de la tabla */
    background-color: #2563eb;
  }
    .page-size-form {
      text-align: center;
      margin-top: 10px;
  }
  .page-size-form label {
      color: #f1f5f9;
      margin-right: 10px;
      font-weight: bold;
  }
  .page-size-form select {
  /* Color de fondo de la tabla */
      background-color: #1e3a5f;
      color: white;
      padding: 6px 12px;
  /* Bordes de la tabla y celdas */
      border: none;
  /* Bordes de la tabla y celdas */
      border-radius: 6px;
  }
  .btn {
    padding: 8px 16px;
  /* Bordes de la tabla y celdas */
    border-radius: 6px;
  /* Bordes de la tabla y celdas */
    border: none;
    font-weight: bold;
    cursor: pointer;
    font-size: 14px;
  }
  /* Color de fondo de la tabla */
  .btn-filtro { background-color: #1e40af; color: white; }
  /* Color de fondo de la tabla */
  .btn-filtrar { background-color: #10b981; color: white; }
  /* Color de fondo de la tabla */
  .btn-limpiar { background-color: #ef4444; color: white; text-decoration: none; display: inline-block; }
  .filter-form {
    display: flex;
    justify-content: center;  /* Centra los filtros horizontalmente */
    flex-wrap: wrap;
    gap: 10px;
    margin: 0 auto 20px auto;  /* Centrado horizontal y espacio inferior */
    max-width: 1000px;         /* Igual al ancho de la tabla */
  }

  .filter-form input[type="text"], .filter-form select {
    padding: 8px 12px;
  /* Bordes de la tabla y celdas */
    border-radius: 6px;
  /* Bordes de la tabla y celdas */
    border: none;
  /* Color de fondo de la tabla */
    background-color: #1e3a5f;  
    color: white;
    min-width: 180px;
    font-size: 14px;
  }
  .filter-actions {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 15px;
  }
    select option.nivel-info {
  /* Color de fondo de la tabla */
    background-color: #10b981;
    color: white;
  }
  select option.nivel-warn {
  /* Color de fondo de la tabla */
    background-color: #facc15;
    color: black;
  }
  select option.nivel-error {
  /* Color de fondo de la tabla */
    background-color: #ef4444;
    color: white;
  }
  select option.nivel-critical {
  /* Color de fondo de la tabla */
    background-color: #b91c1c;
    color: white;
  }

  .exportar-csv, .exportar-pdf {
    padding: 10px 16px;
  /* Bordes de la tabla y celdas */
    border-radius: 8px;
    text-decoration: none;
    font-weight: bold;
    display: inline-block;
    color: white;
  /* Bordes de la tabla y celdas */
    border: none;
  /* Color de fondo de la tabla */
    transition: background-color 0.3s ease;
  }

  .exportar-csv {
  /* Color de fondo de la tabla */
    background-color: #f59e0b; /* azul brillante */
  }

  .exportar-csv:hover {
  /* Color de fondo de la tabla */
    background-color: #d97706;
  }

  .exportar-pdf {
  /* Color de fondo de la tabla */
    background-color: #ec4899; /* verde lima/menta */
  }

  .exportar-pdf:hover {
  /* Color de fondo de la tabla */
    background-color: #db2777;
  }

  
</style>

<h2>Alertas del Sistema</h2>

{% if messages %}
  {% for message in messages %}
    <div class="alert" id="alerta-{{ forloop.counter }}">{{ message }}</div>
  {% endfor %}
{% endif %}

<div class="filter-actions">
  <button id="filtrarBtn" class="btn btn-filtrar" style="display: none;" onclick="document.querySelector('.filter-form').submit()">Filtrar</button>
  <button id="toggleFiltros" class="btn btn-filtro">Mostrar filtros</button>
  <a id="limpiarBtn" href="{% url 'alertas' %}?page_size={{ page_size }}" class="btn btn-limpiar" style="display: none;">Limpiar filtros</a>
</div>

<div id="contenedorFiltros" style="display: none;">
<!-- Formulario de filtrado de alertas -->
  <form method="get" class="filter-form">
    <input type="hidden" name="page_size" value="{{ page_size }}">
    <input type="text" name="fecha" placeholder="Filtrar por fecha (dd/mm/yyyy o hh:mm)" value="{{ fecha_q }}">
    <input type="text" name="titulo" placeholder="Filtrar por título" value="{{ titulo_q }}">
    <input type="text" name="descripcion" placeholder="Filtrar por descripción" value="{{ descripcion_q }}">
    <select name="nivel">
      <option value="">Filtrar por nivel</option>
      <option value="INFO" class="nivel-info" {% if nivel_q == "INFO" %}selected{% endif %}>INFO</option>
      <option value="WARN" class="nivel-warn" {% if nivel_q == "WARN" %}selected{% endif %}>WARN</option>
      <option value="ERROR" class="nivel-error" {% if nivel_q == "ERROR" %}selected{% endif %}>ERROR</option>
      <option value="CRITICAL" class="nivel-critical" {% if nivel_q == "CRITICAL" %}selected{% endif %}>CRITICAL</option>
    </select>
    <input type="text" name="codigo" placeholder="Filtrar por código" value="{{ usuario_q }}">
    <input type="hidden" name="mostrar_filtros" id="mostrarFiltrosInput" value="{{ mostrar_filtros }}">
  </form>
</div>

<div style="text-align: right; margin: 20px auto; max-width: 1150px;">
  <a href="{% url 'exportar_alertas_csv' %}" class="exportar-csv">Exportar CSV</a>
  <a href="{% url 'exportar_alertas_pdf' %}" class="exportar-pdf">Exportar PDF</a>
</div>

<div style="overflow-x: auto;">
<!-- Tabla principal de alertas -->
  <table>
    <thead>
      <tr>
        <th>
          <a href="?sort_by=fecha&order={% if sort_by == 'fecha' and order == 'asc' %}desc{% else %}asc{% endif %}{% if request.GET.page_size %}&page_size={{ request.GET.page_size }}{% endif %}" class="sort-link">
            Fecha/Hora
            {% if sort_by == 'fecha' %}
              {% if order == 'asc' %}▲{% else %}▼{% endif %}
            {% endif %}
          </a>
        </th>
        <th>
          <a href="?sort_by=titulo&order={% if sort_by == 'titulo' and order == 'asc' %}desc{% else %}asc{% endif %}{% if request.GET.page_size %}&page_size={{ request.GET.page_size }}{% endif %}" class="sort-link">
            Título
            {% if sort_by == 'titulo' %}
              {% if order == 'asc' %}▲{% else %}▼{% endif %}
            {% endif %}
          </a>
        </th>
        <th>
          <a href="?sort_by=descripcion&order={% if sort_by == 'descripcion' and order == 'asc' %}desc{% else %}asc{% endif %}{% if request.GET.page_size %}&page_size={{ request.GET.page_size }}{% endif %}" class="sort-link">
            Descripción
            {% if sort_by == 'descripcion' %}
              {% if order == 'asc' %}▲{% else %}▼{% endif %}
            {% endif %}
          </a>
        </th>
        <th>
          <a href="?sort_by=nivel&order={% if sort_by == 'nivel' and order == 'asc' %}desc{% else %}asc{% endif %}{% if request.GET.page_size %}&page_size={{ request.GET.page_size }}{% endif %}" class="sort-link">
            Nivel
            {% if sort_by == 'nivel' %}
              {% if order == 'asc' %}▲{% else %}▼{% endif %}
            {% endif %}
          </a>
        </th>
        <th>
          <a href="?sort_by=usuario&order={% if sort_by == 'usuario' and order == 'asc' %}desc{% else %}asc{% endif %}{% if request.GET.page_size %}&page_size={{ request.GET.page_size }}{% endif %}" class="sort-link">
            Código
            {% if sort_by == 'usuario' %}
              {% if order == 'asc' %}▲{% else %}▼{% endif %}
            {% endif %}
          </a>
        </th>
      </tr>
    </thead>


    <tbody>
      {% for alerta in alertas %}
      <tr>
        <td>{{ alerta.fecha|date:"d/m/Y H:i:s" }}</td>
        <td>{{ alerta.nombre }}</td>
        <td>{{ alerta.descripcion }}</td>
        <td><span class="nivel-{{ alerta.nivel|upper }}">{{ alerta.nivel }}</span></td>
        <td>{{ alerta.codigo }}</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="5" style="text-align:center;">No hay alertas registradas.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>


<div class="page-size-form">
<!-- Formulario de filtrado de alertas -->
  <form method="get">
      <label for="page_size">Ver por página:</label>
      <select name="page_size" id="page_size" onchange="this.form.submit()">
          <option value="5" {% if page_size == 5 %}selected{% endif %}>5</option>
          <option value="10" {% if page_size == 10 %}selected{% endif %}>10</option>
          <option value="25" {% if page_size == 25 %}selected{% endif %}>25</option>
          <option value="50" {% if page_size == 50 %}selected{% endif %}>50</option>
          <option value="100" {% if page_size == 100 %}selected{% endif %}>100</option>
      </select>
      {% if request.GET.page %}
        <input type="hidden" name="page" value="{{ request.GET.page }}">
      {% endif %}
  </form>
</div>


{% if page_obj %}
  <div class="pagination">
<!-- Formulario de filtrado de alertas -->
    <form method="get">
      <input type="hidden" name="fecha" value="{{ fecha_q }}">
      <input type="hidden" name="titulo" value="{{ titulo_q }}">
      <input type="hidden" name="descripcion" value="{{ descripcion_q }}">
      <input type="hidden" name="nivel" value="{{ nivel_q }}">
      <input type="hidden" name="usuario" value="{{ usuario_q }}">
      <input type="hidden" name="page_size" value="{{ page_size }}">
      <input type="hidden" name="mostrar_filtros" value="{{ mostrar_filtros|default:'true' }}">

      {% if page_obj.has_previous %}
        <button name="page" value="1">&laquo; Primera</button>
        <button name="page" value="{{ page_obj.previous_page_number }}">Anterior</button>
      {% endif %}

      <span class="current">
          Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
      </span>

      {% if page_obj.has_next %}
        <button name="page" value="{{ page_obj.next_page_number }}">Siguiente</button>
        <button name="page" value="{{ page_obj.paginator.num_pages }}">&Uacute;ltima &raquo;</button>
      {% endif %}
    </form>
  </div>
{% endif %}


<script>
  document.addEventListener("DOMContentLoaded", function () {
    const btnToggle = document.getElementById("toggleFiltros");
    const filtros = document.getElementById("contenedorFiltros");
    const filtrarBtn = document.getElementById("filtrarBtn");
    const limpiarBtn = document.getElementById("limpiarBtn");
    const inputMostrar = document.getElementById("mostrarFiltrosInput");

    const mostrar = "{{ mostrar_filtros }}" === "true";
    if (mostrar) {
      filtros.style.display = "flex";
      filtrarBtn.style.display = "inline-block";
      limpiarBtn.style.display = "inline-block";
      btnToggle.textContent = "Ocultar filtros";
    } else {
      filtros.style.display = "none";
      filtrarBtn.style.display = "none";
      limpiarBtn.style.display = "none";
      btnToggle.textContent = "Mostrar filtros";
    }

    btnToggle.addEventListener("click", function () {
      const visible = filtros.style.display === "flex";
      filtros.style.display = visible ? "none" : "flex";
      filtrarBtn.style.display = visible ? "none" : "inline-block";
      limpiarBtn.style.display = visible ? "none" : "inline-block";
      btnToggle.textContent = visible ? "Mostrar filtros" : "Ocultar filtros";
      inputMostrar.value = visible ? "false" : "true";
    });

    const alerts = document.querySelectorAll(".alert");
    alerts.forEach(function (alert) {
      setTimeout(function () {
        alert.style.display = "none";
      }, 3000);
    });
  });
</script>

{% endblock %}
