{% extends 'base.html' %}

{% block title %}Registro de Usos{% endblock %}

{% block content %}
<style>
  h2 {
      margin-bottom: 20px;
      color: white;
      text-align: center;
  }
  table {
      width: 1000px;  /* Puedes ajustar el tamaño según el contenido */
      table-layout: fixed;
      border-collapse: collapse;
      background-color: #0f172a;
      color: white;
      border-radius: 10px;
      overflow: hidden;
      margin: auto;
   }

  th, td {
      padding: 12px 16px;
      border: 1px solid #334155;
      text-align: left;
      font-size: 14px;
      word-wrap: break-word;
      overflow-wrap: break-word;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
  }
  th:nth-child(1), td:nth-child(1) { width: 120px; }  /* Usuario Inicio */
  th:nth-child(2), td:nth-child(2) { width: 120px; }  /* Usuario Fin */
  th:nth-child(3), td:nth-child(3) { width: 150px; }  /* Frecuencia */
  th:nth-child(4), td:nth-child(4) { width: 200px; }  /* Ubicación */
  th:nth-child(5), td:nth-child(5) { width: 150px; }  /* Inicio */
  th:nth-child(6), td:nth-child(6) { width: 150px; }  /* Fin */

  th {
      background-color: #1e40af;
      color: white;
  }
  tr:nth-child(even) {
      background-color: #1e293b;
  }
  tr:hover {
      background-color: #334155;
  }
  .alert {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #1e3a8a;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      z-index: 9999;
      opacity: 0.9;
  }

  .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
  }
  .pagination a, .pagination span {
      color: white;
      background-color: #1e3a5f;
      padding: 8px 14px;
      margin: 0 4px;
      border-radius: 6px;
      text-decoration: none;
      transition: background-color 0.3s;
  }
  .pagination a:hover {
      background-color: #2563eb;
  }
  .pagination .current {
      background-color: #10b981;
      font-weight: bold;
  }

  .page-size-form {
      text-align: center;
      margin-top: 10px;
  }
  .page-size-form label {
      color: #f1f5f9;
      margin-right: 10px;
      font-weight: bold;
  }
  .page-size-form select {
      background-color: #1e3a5f;
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
  }

  .sort-link {
      color: #f1f5f9;
      text-decoration: none;
      font-weight: bold;
      display: inline-block;
      padding: 6px 10px;
      border-radius: 6px;
      background-color: #1e40af;
      transition: background-color 0.3s, box-shadow 0.3s;
  }
  .sort-link:hover {
      background-color: #2563eb;
      box-shadow: 0 0 5px #3b82f6;
  }
  .sort-link span {
      margin-left: 5px;
  }
.filter-form {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 10px;
}

.filter-form input[type="text"] {
  padding: 8px 12px;
  border-radius: 6px;
  border: none;
  background-color: #1e3a5f;
  color: white;
  min-width: 180px;
  font-size: 14px;
}

.btn {
  padding: 8px 16px;
  border-radius: 6px;
  border: none;
  font-weight: bold;
  cursor: pointer;
  font-size: 14px;
}
.btn-filtro { background-color: #1e40af; color: white; }
.btn-filtrar { background-color: #10b981; color: white; }
.btn-limpiar { background-color: #ef4444; color: white; text-decoration: none; display: inline-block; }

.filter-actions {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-bottom: 15px;
}
.btn-export-csv {
    background-color: #f59e0b; /* amarillo suave */
    color: white;
    font-weight: bold;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    margin-left: 10px;
    text-decoration: none;
    transition: background-color 0.3s;
}
.btn-export-csv:hover {
    background-color: #d97706;
}

.btn-export-pdf {
    background-color: #ec4899; /* rosado suave */
    color: white;
    font-weight: bold;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    margin-left: 10px;
    text-decoration: none;
    transition: background-color 0.3s;
}
.btn-export-pdf:hover {
    background-color: #db2777;
}

  
</style>

<h2>Registro de Usos del Jammer</h2>

{% if messages %}
  {% for message in messages %}
    <div class="alert" id="alerta-{{ forloop.counter }}">{{ message }}</div>
  {% endfor %}
{% endif %}


<form method="get">
  <div class="filter-actions">
    <button type="submit" id="filtrarBtn" class="btn btn-filtrar" style="display: none;">Filtrar</button>
    <button id="toggleFiltros" type="button" class="btn btn-filtro">Mostrar filtros</button>
    <a id="limpiarBtn" href="{% url 'usos' %}?page_size={{ page_size }}" class="btn btn-limpiar" style="display: none;">Limpiar filtros</a>
  </div>

  <div id="contenedorFiltros" style="display: none; margin-bottom: 20px;" class="filter-form">
    <input type="hidden" name="page_size" value="{{ page_size }}">
    <input type="text" name="usuario_inicio" placeholder="Usuario inicio" value="{{ request.GET.usuario_inicio }}">
    <input type="text" name="usuario_fin" placeholder="Usuario fin" value="{{ request.GET.usuario_fin }}">
    <input type="text" name="frecuencia" placeholder="Frecuencia MHz" value="{{ request.GET.frecuencia }}">
    <input type="text" name="ubicacion" placeholder="Ubicación" value="{{ request.GET.ubicacion }}">
    <input type="text" name="inicio" placeholder="Inicio (DD-MM-YYYY)" value="{{ request.GET.inicio }}">
    <input type="text" name="fin" placeholder="Fin (DD-MM-YYYY)" value="{{ request.GET.fin }}">

    <input type="hidden" name="sort_by" value="{{ sort_by }}">
    <input type="hidden" name="order" value="{{ order }}">
    <input type="hidden" name="mostrar_filtros" id="mostrarFiltrosInput" value="{{ mostrar_filtros }}">
  </div>
</form>

<div style="text-align: right; margin: 20px auto; max-width: 1000px;">
  <a href="{% url 'exportar_usos_csv' %}" class="btn-export-csv">Exportar CSV</a>
  <a href="{% url 'exportar_usos_pdf' %}" class="btn-export-pdf">Exportar PDF</a>
</div>


<div id="tabla-usos" hx-get="{% url 'usos' %}" hx-trigger="click from:.sort-link" hx-target="#tabla-usos" hx-swap="outerHTML">
  <table>
    <thead>
      <tr>
        <th>
          <a href="?sort_by=usuario_inicio&order={% if sort_by == 'usuario_inicio' and order == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link">
            Usuario Inicio {% if sort_by == 'usuario_inicio' %}{% if order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
          </a>
        </th>
        <th>
          <a href="?sort_by=usuario_fin&order={% if sort_by == 'usuario_fin' and order == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link">
            Usuario Fin {% if sort_by == 'usuario_fin' %}{% if order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
          </a>
        </th>
        <th>
          <a href="?sort_by=frecuencia&order={% if sort_by == 'frecuencia' and order == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link">
            Frecuencia (MHz) {% if sort_by == 'frecuencia' %}{% if order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
          </a>
        </th>
        <th>
          <a href="?sort_by=ubicacion&order={% if sort_by == 'ubicacion' and order == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link">
            Ubicación {% if sort_by == 'ubicacion' %}{% if order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
          </a>
        </th>
        <th>
          <a href="?sort_by=inicio&order={% if sort_by == 'inicio' and order == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link">
            Inicio {% if sort_by == 'inicio' %}{% if order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
          </a>
        </th>
        <th>
          <a href="?sort_by=fin&order={% if sort_by == 'fin' and order == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link">
            Fin {% if sort_by == 'fin' %}{% if order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
          </a>
        </th>
      </tr>
    </thead>
    <tbody>
      {% for r in registros %}
        <tr>
          <td>{{ r.1 }}</td>
          <td>{{ r.2 }}</td>
          <td>{{ r.3 }}</td>
          <td>{{ r.4 }}</td>
          <td>{{ r.5|date:"d/m/Y H:i:s" }}</td>
          <td>
            {% if r.6 %}
              {{ r.6|date:"d/m/Y H:i:s" }}
            {% else %}
              Activo
            {% endif %}
          </td>
        </tr>
      {% empty %}
        <tr><td colspan="6" style="text-align:center;">No hay registros.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="page-size-form">
  <form method="get">
      <label for="page_size">Ver por página:</label>
      <select name="page_size" id="page_size" onchange="this.form.submit()">
          <option value="5" {% if page_size == 5 %}selected{% endif %}>5</option>
          <option value="10" {% if page_size == 10 %}selected{% endif %}>10</option>
          <option value="25" {% if page_size == 25 %}selected{% endif %}>25</option>
          <option value="50" {% if page_size == 50 %}selected{% endif %}>50</option>
          <option value="100" {% if page_size == 100 %}selected{% endif %}>100</option>
      </select>
      {% if request.GET.page %}
        <input type="hidden" name="page" value="{{ request.GET.page }}">
      {% endif %}
  </form>
</div>

{% if page_obj %}
  <div class="pagination">
    {% if page_obj.has_previous %}
      <a href="?page=1
        &page_size={{ page_size }}
        &sort_by={{ sort_by }}
        &order={{ order }}
        &usuario_inicio={{ usuario_inicio_q }}
        &usuario_fin={{ usuario_fin_q }}
        &frecuencia={{ frecuencia_q }}
        &ubicacion={{ ubicacion_q }}
        &inicio={{ inicio_q }}
        &fin={{ fin_q }}
        &mostrar_filtros={{ mostrar_filtros }}">&laquo; Primera</a>

      <a href="?page={{ page_obj.previous_page_number }}
        &page_size={{ page_size }}
        &sort_by={{ sort_by }}
        &order={{ order }}
        &usuario_inicio={{ usuario_inicio_q }}
        &usuario_fin={{ usuario_fin_q }}
        &frecuencia={{ frecuencia_q }}
        &ubicacion={{ ubicacion_q }}
        &inicio={{ inicio_q }}
        &fin={{ fin_q }}
        &mostrar_filtros={{ mostrar_filtros }}">Anterior</a>
    {% endif %}

    <span class="current">
        Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
    </span>

    {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}
        &page_size={{ page_size }}
        &sort_by={{ sort_by }}
        &order={{ order }}
        &usuario_inicio={{ usuario_inicio_q }}
        &usuario_fin={{ usuario_fin_q }}
        &frecuencia={{ frecuencia_q }}
        &ubicacion={{ ubicacion_q }}
        &inicio={{ inicio_q }}
        &fin={{ fin_q }}
        &mostrar_filtros={{ mostrar_filtros }}">Siguiente</a>


      <a href="?page={{ page_obj.paginator.num_pages }}
        &page_size={{ page_size }}
        &sort_by={{ sort_by }}
        &order={{ order }}
        &usuario_inicio={{ usuario_inicio_q }}
        &usuario_fin={{ usuario_fin_q }}
        &frecuencia={{ frecuencia_q }}
        &ubicacion={{ ubicacion_q }}
        &inicio={{ inicio_q }}
        &fin={{ fin_q }}
        &mostrar_filtros={{ mostrar_filtros }}">Última &raquo;</a>
    {% endif %}
  </div>
{% endif %}


<script>
  document.addEventListener("DOMContentLoaded", function () {
    const btnToggle = document.getElementById("toggleFiltros");
    const filtros = document.getElementById("contenedorFiltros");
    const filtrarBtn = document.getElementById("filtrarBtn");
    const limpiarBtn = document.getElementById("limpiarBtn");
    const inputMostrar = document.getElementById("mostrarFiltrosInput");

    const mostrar = "{{ mostrar_filtros }}" === "true";
    if (mostrar) {
      filtros.style.display = "flex";
      filtrarBtn.style.display = "inline-block";
      limpiarBtn.style.display = "inline-block";
      btnToggle.textContent = "Ocultar filtros";
    } else {
      filtros.style.display = "none";
      filtrarBtn.style.display = "none";
      limpiarBtn.style.display = "none";
      btnToggle.textContent = "Mostrar filtros";
    }

    btnToggle.addEventListener("click", function () {
      const visible = filtros.style.display === "flex";
      filtros.style.display = visible ? "none" : "flex";
      filtrarBtn.style.display = visible ? "none" : "inline-block";
      limpiarBtn.style.display = visible ? "none" : "inline-block";
      btnToggle.textContent = visible ? "Mostrar filtros" : "Ocultar filtros";
      inputMostrar.value = visible ? "false" : "true";
    });
  });
</script>




<script>
  document.addEventListener("DOMContentLoaded", function () {
    const alerts = document.querySelectorAll(".alert");
    alerts.forEach(function (alert) {
      setTimeout(function () {
        alert.style.display = "none";
      }, 3000);
    });
  });
</script>
{% endblock %}
